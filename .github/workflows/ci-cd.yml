name: CI/CD Pipeline

on:
  push:
    branches: [ main, staging ]

env:
  IMAGE_NAME: demo-django

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build metadata image
      run: echo "image-tag=${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT


  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: staging

    steps:
    - uses: actions/checkout@v4

    # ---------------------------
    # CREATE KIND CLUSTER
    # ---------------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind

    # ---------------------------
    # BUILD DOCKER IMAGE
    # ---------------------------
    - name: Build Docker image
      run: |
        docker build -t demo-django:${{ github.sha }} -f django-app/Dockerfile django-app
        docker images | grep demo-django || (echo "Image not built"; exit 1)

    # ---------------------------
    # LOAD IMAGE INTO KIND
    # ---------------------------
    - name: Load Docker image into KIND
      run: |
        kind load docker-image demo-django:${{ github.sha }} --name kind

    # ---------------------------
    # APPLY UPDATED MANIFESTS
    # ---------------------------
    - name: Apply Kubernetes manifests
      run: |
        # Always start from a clean manifest
        git checkout -- k8s/deployment.yaml

        sed -i "s|demo-django:local|demo-django:${{ github.sha }}|g" k8s/deployment.yaml

        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/webhook-receiver.yaml
        kubectl apply -f k8s/webhook-secret.yaml

    # ---------------------------
    # WAIT FOR ROLLOUT
    # ---------------------------
    - name: Wait for rollout
      id: rollout
      continue-on-error: true
      run: |
        kubectl rollout status deployment/demo-django --timeout=90s

    # ---------------------------
    # MARK FAILURE IF ROLLOUT FAILED
    # ---------------------------
    - name: Mark deploy job failed
      if: steps.rollout.outcome == 'failure'
      run: |
        echo "ROLLLOUT FAILED"
        exit 1

    # ---------------------------
    # SMOKE TEST (ONLY if rollout SUCCESSFUL)
    # ---------------------------
    - name: Smoke test
      if: steps.rollout.outcome == 'success'
      run: |
        kubectl port-forward svc/demo-django 8080:80 >/dev/null 2>&1 &
        sleep 4
        curl -f http://127.0.0.1:8080/health || (echo "Smoke test failed"; exit 1)


  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - uses: actions/checkout@v4

    # ---------------------------
    # RECREATE KIND CLUSTER
    # ---------------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind

    # ---------------------------
    # CREATE ROLLOUT HISTORY (2 revisions)
    # ---------------------------

    # REVISION 1 â€” stable image
    - name: Deploy revision 1 (stable)
      run: |
        git checkout -- k8s/deployment.yaml
        sed -i "s|demo-django:local|demo-django:stable|g" k8s/deployment.yaml

        kubectl apply -f k8s/deployment.yaml
        kubectl rollout status deployment/demo-django --timeout=60s

    # REVISION 2 â€” broken image
    - name: Deploy revision 2 (failed version)
      run: |
        sed -i "s|demo-django:stable|demo-django:broken|g" k8s/deployment.yaml
        kubectl apply -f k8s/deployment.yaml

    # ---------------------------
    # NOW ROLLBACK WILL WORK
    # ---------------------------
    - name: Rollback Deployment
      run: |
        echo "Running rollback..."
        kubectl rollout undo deployment/demo-django
        kubectl rollout status deployment/demo-django --timeout=60s || true

    # ---------------------------
    # SLACK NOTIFICATION
    # ---------------------------
    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ *Automatic Rollback Executed Successfully*\nThe deployment failed and was rolled back to a stable version."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
