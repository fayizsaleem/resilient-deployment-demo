name: CI/CD Pipeline

on:
  push:
    branches: [ main, staging ]

env:
  IMAGE_NAME: demo-django

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build metadata image
      run: |
        echo "image-tag=$IMAGE_NAME:${{ github.sha }}" >> $GITHUB_OUTPUT


  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
    - uses: actions/checkout@v4

    # ---------------------------
    # CREATE KIND CLUSTER
    # ---------------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind

    # ---------------------------
    # BUILD DOCKER IMAGE
    # ---------------------------
    - name: Build Docker image inside deploy job
      run: |
        docker build \
           -t demo-django:${{ github.sha }} \
           -f django-app/Dockerfile \
           django-app

        docker images | grep demo-django || (echo "IMAGE BUILD FAILED"; exit 1)

    # ---------------------------
    # LOAD IMAGE INTO KIND
    # ---------------------------
    - name: Load Docker image into KIND
      run: |
        kind load docker-image demo-django:${{ github.sha }} --name kind

    # ---------------------------
    # APPLY MANIFESTS
    # ---------------------------
    - name: Apply Kubernetes manifests
      run: |
        sed -i "s|demo-django:local|demo-django:${{ github.sha }}|g" k8s/deployment.yaml

        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/webhook-receiver.yaml
        kubectl apply -f k8s/webhook-secret.yaml

    # ---------------------------
    # WAIT FOR ROLLOUT â€” MUST CAPTURE FAILURE
    # ---------------------------
    - name: Wait for rollout
      id: rollout
      continue-on-error: true
      run: |
        echo "Waiting for rollout..."
        kubectl rollout status deployment/demo-django --timeout=90s

    # ---------------------------
    # FAIL DEPLOY JOB ON ROLLOUT FAILURE
    # ---------------------------
    - name: Mark deploy job as failed if rollout failed
      if: steps.rollout.outcome == 'failure'
      run: |
        echo "ROLLLOUT FAILED - failing deploy job"
        exit 1

    # ---------------------------
    # SMOKE TEST (only if rollout succeeded)
    # ---------------------------
    - name: Smoke test
      if: steps.rollout.outcome == 'success'
      run: |
        kubectl port-forward svc/demo-django 8080:80 >/dev/null 2>&1 &
        sleep 4
        if ! curl -fsS http://127.0.0.1:8080/health; then
          echo "SMOKE TEST FAILED"
          exit 1
        fi


  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - uses: actions/checkout@v4

    # ---------------------------
    # RECREATE KIND CLUSTER
    # ---------------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind
    - name: Apply manifests before rollback
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
    # ---------------------------
    # ROLLBACK DEPLOYMENT
    # ---------------------------
    - name: Rollback Deployment
      run: |
        echo "Executing rollback..."
        kubectl rollout undo deployment/demo-django
        kubectl rollout status deployment/demo-django --timeout=90s || true

    # ---------------------------
    # SLACK NOTIFICATION
    # ---------------------------
    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ *Automatic Rollback Executed*\nDeployment failed. KIND cluster rolled back to last stable version."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
