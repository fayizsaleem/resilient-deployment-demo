name: CI/CD

on:
  push:
    branches: [ main, staging ]

env:
  IMAGE_NAME: demo-django

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build local image (no push needed for KIND)
      id: meta
      run: |
        docker build -t $IMAGE_NAME:${{ github.sha }} -f django-app/Dockerfile django-app
        echo "image-tag=$IMAGE_NAME:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
    - uses: actions/checkout@v4

    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0

    - name: Load Docker image into KIND
      run: |
        kind load docker-image ${{ needs.build-and-push.outputs.image-tag }}

    - name: Apply Kubernetes manifests
      run: |
        sed -i "s|demo-django:local|${{ needs.build-and-push.outputs.image-tag }}|g" k8s/deployment.yaml
        kubectl apply -f k8s/

    - name: Wait for rollout
      run: kubectl rollout status deployment/demo-django --timeout=90s

    - name: Smoke test
      run: |
        kubectl port-forward svc/demo-django 8080:80 >/dev/null 2>&1 &
        sleep 4
        if ! curl -fsS http://127.0.0.1:8080/health; then
          echo "SMOKE TEST FAILED"
          exit 1
        fi

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0

    - name: Rollback deployment
      run: |
        kubectl rollout undo deployment/demo-django || true
        kubectl rollout status deployment/demo-django --timeout=90s || true

    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ *Automatic Rollback Executed in CI/CD*\nDeployment failed. KIND cluster rolled back to last stable version."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
