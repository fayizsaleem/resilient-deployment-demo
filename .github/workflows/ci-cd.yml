name: CI/CD Pipeline

on:
  push:
    branches: [ main, staging ]

env:
  IMAGE_NAME: demo-django

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    # Build image ONLY for metadata â€” real build happens in deploy job
    - name: Build metadata image
      run: |
        echo "image-tag=$IMAGE_NAME:${{ github.sha }}" >> $GITHUB_OUTPUT


  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
    - uses: actions/checkout@v4


    -name: Configure Kubeconfig
     run: |
       mkdir -p ~/.kube
       echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
       kubectl config set-cluster k3s --server=https://172.25.72.65:6443 --insecure-skip-tls-verify=true
    # ----------------------
    # CREATE KIND CLUSTER
    # ----------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind

    # ----------------------
    # BUILD DOCKER IMAGE LOCALLY
    # ----------------------
    - name: Build Docker image inside deploy job
      run: |
        docker build -t demo-django:${{ github.sha }} -f django-app/Dockerfile django-app

    # ----------------------
    # LOAD IMAGE INTO KIND
    # ----------------------
    - name: Load Docker image into KIND
      run: |
        kind load docker-image demo-django:${{ github.sha }} --name kind

    # ----------------------
    # APPLY KUBERNETES MANIFESTS
    # ----------------------
    - name: Apply Kubernetes manifests
      run: |
        # Update image tag inside deployment file
        sed -i "s|demo-django:local|demo-django:${{ github.sha }}|g" k8s/deployment.yaml

        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/webhook-receiver.yaml
        kubectl apply -f k8s/webhook-secret.yaml

    # ----------------------
    # WAIT FOR ROLLOUT
    # ----------------------
    - name: Wait for rollout
      run: kubectl rollout status deployment/demo-django --timeout=90s

    # ----------------------
    # SMOKE TEST
    # ----------------------
    - name: Smoke test
      run: |
        kubectl port-forward svc/demo-django 8080:80 >/dev/null 2>&1 &
        sleep 4
        if ! curl -fsS http://127.0.0.1:8080/health; then
          echo "SMOKE TEST FAILED"
          exit 1
        fi


  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - uses: actions/checkout@v4

    - name: Configure Kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
        kubectl config set-cluster k3s --server=https://172.25.72.65:6443 --insecure-skip-tls-verify=true

    # ----------------------
    # CREATE KIND CLUSTER AGAIN
    # ----------------------
    - name: Create KIND Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: kind

    # ----------------------
    # ROLLBACK DEPLOYMENT
    # ----------------------
    - name: Rollback Deployment
      run: |
        kubectl rollout undo deployment/demo-django || true
        kubectl rollout status deployment/demo-django --timeout=90s || true

    # ----------------------
    # SLACK NOTIFICATION
    # ----------------------
    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ *Automatic Rollback Executed*\nDeployment failed in CI/CD. KIND cluster reverted to last stable version."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
