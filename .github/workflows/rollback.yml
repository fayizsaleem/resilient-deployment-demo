name: Rollback Workflow

on:
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'reason'
        required: true
        default: 'manual'

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
    - name: Configure Kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG }}" | base64 --decode > kubeconfig
        mkdir -p $HOME/.kube
        mv kubeconfig $HOME/.kube/config
    - name: Rollback deployment
      run: |
        kubectl -n default rollout undo deployment/demo-django || true
        kubectl -n default rollout status deployment/demo-django --timeout=120s || true
    - name: Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "ðŸš¨ *Rollback Executed Successfully*\nDeployment failed and the cluster has been reverted to the last stable version."
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
